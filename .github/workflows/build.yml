name: Build OpenWrt for Orange Pi 5 Plus

# This workflow builds OpenWrt firmware specifically for Xunlong Orange Pi 5 Plus
# Using OpenWrt SDK Docker container with caching support
# Triggered on pushes and pull requests to master branch
# Uses orange-pi-5-plus.config for consistent builds

on:
  push:
    branches: [ master ]
    paths:
      - 'orange-pi-5-plus.config'
      - '.config'
      - 'package/**'
      - 'target/**'
      - 'config/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ master ]
    paths:
      - 'orange-pi-5-plus.config'
      - '.config'
      - 'package/**'
      - 'target/**'
      - 'config/**'
      - '.github/workflows/build.yml'

env:
  FORCE_UNSAFE_CONFIGURE: 1

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 512
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: orangepi-5-plus-${{ hashFiles('.config') }}
        restore-keys: |
          orangepi-5-plus-
        max-size: 2G

    - name: Cache dl files
      uses: actions/cache@v4
      with:
        path: dl
        key: dl-cache-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          dl-cache-

    - name: Cache staging_dir
      uses: actions/cache@v4
      with:
        path: staging_dir
        key: staging-cache-orangepi-5-plus-${{ hashFiles('.config') }}
        restore-keys: |
          staging-cache-orangepi-5-plus-

    - name: Setup Build Configuration
      run: |
        echo "=== Orange Pi 5 Plus Build Configuration ==="
        echo "Target Device: Xunlong Orange Pi 5 Plus"
        echo "Target Platform: Rockchip RK3588 Armv8"
        echo "Build Environment: OpenWrt SDK Docker Container"

        # Check for orange-pi-5-plus.config in project root
        if [ ! -f orange-pi-5-plus.config ]; then
          echo "ERROR: orange-pi-5-plus.config not found in project root!"
          echo ""
          echo "This file is required for Orange Pi 5 Plus builds."
          echo "Please ensure the file exists in the repository root."
          echo ""
          echo "To create it from your current .config:"
          echo "  cp .config orange-pi-5-plus.config"
          echo "  git add orange-pi-5-plus.config"
          echo "  git commit -m 'Add Orange Pi 5 Plus config'"
          echo "  git push"
          echo ""
          echo "Available files in current directory:"
          ls -la | head -10
          exit 1
        fi

        echo "✓ Found orange-pi-5-plus.config in project root"

        # Validate the config file contains Orange Pi 5 Plus settings
        echo "=== Config Validation ==="
        if grep -q "CONFIG_TARGET.*orangepi.*5.*plus" orange-pi-5-plus.config; then
          echo "✓ Orange Pi 5 Plus configuration validated"
        else
          echo "ERROR: Config file does not contain Orange Pi 5 Plus settings!"
          echo "Please verify the config file is correct for Orange Pi 5 Plus."
          exit 1
        fi

        # Copy to .config for build system
        cp orange-pi-5-plus.config .config
        echo "✓ Config file copied to .config for build system"

    - name: Build in OpenWrt SDK Container
      run: |
        # Run build in Docker container
        docker run --rm \
          -v $(pwd):/home/build/openwrt \
          -v ~/.ccache:/home/build/.ccache \
          -w /home/build/openwrt \
          openwrt/sdk:latest \
          /bin/bash -c "
            # Setup build environment
            echo 'Setting up build environment...'
            export FORCE_UNSAFE_CONFIGURE=1
            export PATH=/usr/lib/ccache:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

            # Configure git for reproducible builds
            git config --global user.name 'OpenWrt CI'
            git config --global user.email 'ci@openwrt.org'

            # Verify .config exists (should have been copied from orange-pi-5-plus.config)
            if [ ! -f .config ]; then
              echo 'ERROR: .config file not found!'
              echo 'This indicates the config setup step failed.'
              exit 1
            fi

            echo '✓ .config file verified'

            # Update feeds
            echo 'Updating feeds...'
            ./scripts/feeds update -a
            ./scripts/feeds install -a

            # Load and validate configuration
            echo 'Loading configuration...'
            make defconfig

            # Show build info
            echo '=== Build Information ==='
            echo 'Target Device: Orange Pi 5 Plus'
            echo 'Configuration: Based on orange-pi-5-plus.config'
            echo 'CPU Cores:' \$(nproc)
            echo 'Available Memory:' \$(free -h | grep '^Mem:' | awk '{print \$2}')
            echo 'Disk Space:' \$(df -h . | tail -1 | awk '{print \$4}')

            # Download sources
            echo 'Downloading package sources...'
            make download -j\$(nproc) || make download -j1

            # Build toolchain
            echo 'Building toolchain...'
            make toolchain/install -j\$(nproc) V=s

            # Build target firmware
            echo 'Building Orange Pi 5 Plus firmware...'
            make -j\$(nproc) V=s || make -j1 V=s

            # Show build results
            echo '=== Build Completed ==='
            echo 'Firmware files:'
            find bin/targets -name '*orangepi*5*plus*' -o -name '*.bin' -o -name '*.img' | head -10
          "

    - name: Show ccache stats
      run: |
        ccache --show-stats || echo "ccache stats not available"

    - name: Prepare artifacts
      if: success()
      run: |
        echo "=== Preparing Build Artifacts ==="
        mkdir -p artifacts

        # Find Orange Pi 5 Plus specific files
        echo "Looking for Orange Pi 5 Plus firmware files..."
        find bin/targets -name "*orangepi*5*plus*" -o -name "*rk3588*" | \
          xargs -I {} cp {} artifacts/ 2>/dev/null || true

        # Also copy any generic firmware files
        find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.tar.gz" | \
          xargs -I {} cp {} artifacts/ 2>/dev/null || true

        # Copy IPK packages if any
        find bin/packages -name "*.ipk" 2>/dev/null | head -20 | \
          xargs -I {} cp {} artifacts/ 2>/dev/null || true

        echo "=== Artifacts Created ==="
        ls -lah artifacts/ || echo "No artifacts found"

        # Show disk usage
        echo "=== Disk Usage ==="
        df -h . | tail -1
        du -sh bin/ staging_dir/ dl/ 2>/dev/null || true

    - name: Upload Orange Pi 5 Plus firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: orangepi-5-plus-firmware-${{ github.run_number }}
        path: artifacts/
        retention-days: 7

    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: orangepi-5-plus-build-logs-${{ github.run_number }}
        path: |
          .config
          logs/ 2>/dev/null || true
        retention-days: 7